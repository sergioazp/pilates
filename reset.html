<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer Contraseña - Marina Pilates</title>

    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .logo {
            text-align: center;
            margin-bottom: 28px;
        }

        .logo-circle {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 2rem;
        }

        .logo h1 {
            color: #667eea;
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .logo p {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
        }

        .form-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.2s;
            outline: none;
        }

        .form-group input:focus {
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102,126,234,0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .alert {
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .alert-danger  { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-info    { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .back-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .back-link:hover { text-decoration: underline; }

        .password-wrap { position: relative; }

        .toggle-pw {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6c757d;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-wrap input { padding-right: 44px; }

        @media (max-width: 480px) {
            body { padding: 0; align-items: flex-end; }
            .card { border-radius: 20px 20px 0 0; padding: 32px 24px 40px; }
        }
    </style>
</head>
<body>

<div class="card">
    <div class="logo">
        <img src="marina_pilates_logo_v03.svg" alt="Marina Pilates" width="200" style="display:block;margin:0 auto 8px" />
        <p style="color:#6c757d;font-size:0.85rem;margin-top:4px;">Creá tu nueva contraseña</p>
    </div>

    <div id="estado-cargando" class="alert alert-info">
        ⏳ Verificando enlace...
    </div>

    <div id="estado-error" class="alert alert-danger" style="display:none;"></div>

    <div id="formulario" style="display:none;">
        <div class="form-group">
            <label for="nueva">Nueva contraseña</label>
            <div class="password-wrap">
                <input type="password" id="nueva" placeholder="Mínimo 6 caracteres" autocomplete="new-password" />
                <button class="toggle-pw" onclick="toggleVer('nueva', this)" tabindex="-1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>
        </div>
        <div class="form-group">
            <label for="confirmar">Repetir contraseña</label>
            <div class="password-wrap">
                <input type="password" id="confirmar" placeholder="Repetí la contraseña" autocomplete="new-password" />
                <button class="toggle-pw" onclick="toggleVer('confirmar', this)" tabindex="-1">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>
        </div>
        <button class="btn btn-primary" id="btn-guardar" onclick="guardarPassword()">
            Guardar contraseña
        </button>
    </div>

    <div id="exito" style="display:none;">
        <div class="alert alert-success">
            ✅ <strong>¡Contraseña actualizada!</strong><br/>
            Ya podés ingresar a la app con tu nueva contraseña.
        </div>
        <a href="/" class="btn btn-primary" style="display:block; text-align:center; text-decoration:none; margin-top:4px;">
            Ir a la app
        </a>
    </div>

    <a href="/" class="back-link">← Volver al inicio</a>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDJDMsiLBABUdPMNaRyfJ-s2MTwse-kX1w",
        authDomain: "marina-pilates-730fb.firebaseapp.com",
        projectId: "marina-pilates-730fb",
        storageBucket: "marina-pilates-730fb.firebasestorage.app",
        messagingSenderId: "392495630154",
        appId: "1:392495630154:web:735dca0f037ded59ad63b3"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Extraer oobCode de la URL
    const params = new URLSearchParams(window.location.search);
    const oobCode = params.get('oobCode');
    const mode    = params.get('mode');

    function mostrar(id) {
        ['estado-cargando','estado-error','formulario','exito']
            .forEach(el => document.getElementById(el).style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }

    function mostrarError(msg) {
        document.getElementById('estado-error').innerHTML = msg;
        mostrar('estado-error');
    }

    const eyeOpen = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
    const eyeClosed = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><path d="M14.12 14.12a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';

    function toggleVer(inputId, btn) {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
            input.type = 'text';
            btn.innerHTML = eyeClosed;
        } else {
            input.type = 'password';
            btn.innerHTML = eyeOpen;
        }
    }

    async function guardarPassword() {
        const nueva     = document.getElementById('nueva').value;
        const confirmar = document.getElementById('confirmar').value;
        const btn       = document.getElementById('btn-guardar');

        if (nueva.length < 6) {
            return mostrarError('❌ La contraseña debe tener al menos 6 caracteres.');
        }
        if (nueva !== confirmar) {
            return mostrarError('❌ Las contraseñas no coinciden.');
        }

        btn.disabled = true;
        btn.textContent = '⏳ Guardando...';

        try {
            await auth.confirmPasswordReset(oobCode, nueva);
            mostrar('exito');
        } catch (e) {
            console.error(e);
            if (e.code === 'auth/expired-action-code') {
                mostrarError('❌ El enlace expiró. Pedí uno nuevo desde la app.');
            } else if (e.code === 'auth/invalid-action-code') {
                mostrarError('❌ El enlace no es válido o ya fue usado. Pedí uno nuevo.');
            } else {
                mostrarError('❌ Error al guardar. Intentá de nuevo.');
            }
            btn.disabled = false;
            btn.textContent = 'Guardar contraseña';
        }
    }

    // Verificar el código al cargar
    (async () => {
        if (mode !== 'resetPassword' || !oobCode) {
            return mostrarError('❌ Enlace inválido. Asegurate de usar el link del mail.');
        }
        try {
            await auth.verifyPasswordResetCode(oobCode);
            mostrar('formulario');
        } catch (e) {
            if (e.code === 'auth/expired-action-code') {
                mostrarError('❌ El enlace expiró. Pedí uno nuevo desde la app.');
            } else {
                mostrarError('❌ Enlace inválido o ya usado. Pedí uno nuevo desde la app.');
            }
        }
    })();
</script>

</body>
</html>
