<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carga de Alumnos - Marina Pilates</title>

    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 36px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            font-size: 1.5rem;
            margin-bottom: 6px;
            text-align: center;
        }

        .subtitle {
            color: #6c757d;
            text-align: center;
            font-size: 0.9rem;
            margin-bottom: 28px;
        }

        .step {
            margin-bottom: 24px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .step-title {
            font-weight: 600;
            color: #495057;
        }

        .step.active { border-color: #667eea; }
        .step.done { border-color: #28a745; background: #f8fff8; }

        .file-drop {
            border: 2px dashed #ced4da;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #6c757d;
        }

        .file-drop:hover { border-color: #667eea; background: #f8f9ff; }
        .file-drop.dragover { border-color: #667eea; background: #eef1ff; }

        .file-drop input { display: none; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin-top: 12px;
        }

        th {
            background: #667eea;
            color: white;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
        }

        th:first-child { border-radius: 8px 0 0 0; }
        th:last-child { border-radius: 0 8px 0 0; }

        td {
            padding: 8px 12px;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover td { background: #f8f9ff; }

        tr.duplicate td { background: #fff3cd; color: #856404; }
        tr.error td { background: #f8d7da; color: #721c24; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-new { background: #d4edda; color: #155724; }
        .badge-exists { background: #fff3cd; color: #856404; }
        .badge-error { background: #f8d7da; color: #721c24; }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102,126,234,0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .alert {
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        .stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .stat {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .stat-total { background: #e8eaff; color: #667eea; }
        .stat-new { background: #d4edda; color: #155724; }
        .stat-exists { background: #fff3cd; color: #856404; }
        .stat-error { background: #f8d7da; color: #721c24; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .login-form {
            max-width: 360px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            outline: none;
        }

        .form-group input:focus { border-color: #667eea; }

        #tabla-container { max-height: 400px; overflow-y: auto; }

        .scroll-hint {
            text-align: center;
            color: #6c757d;
            font-size: 0.8rem;
            margin-top: 4px;
        }
    </style>
</head>
<body>

<div class="card">
    <h1>Carga de Alumnos</h1>
    <p class="subtitle">Marina Pilates — Herramienta de importación</p>

    <!-- LOGIN -->
    <div id="login-section">
        <div class="alert alert-info">
            Ingresá con la cuenta admin para cargar alumnos a Firebase.
        </div>
        <div class="login-form">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="login-email" value="marinapilatesestudio@gmail.com" />
            </div>
            <div class="form-group">
                <label>Contraseña</label>
                <input type="password" id="login-password" placeholder="Contraseña admin" />
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="login()">Ingresar</button>
            <div id="login-error" style="margin-top:12px"></div>
        </div>
    </div>

    <!-- CARGA -->
    <div id="carga-section" style="display:none">

        <!-- Paso 1: Subir archivo -->
        <div class="step active" id="step1">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">Subir archivo Excel (.xlsx)</div>
            </div>
            <div class="file-drop" id="file-drop" onclick="document.getElementById('file-input').click()">
                <input type="file" id="file-input" accept=".xlsx,.xls,.csv" onchange="handleFile(this.files[0])" />
                <p><strong>Hacé click acá</strong> o arrastrá tu archivo</p>
                <p style="font-size:0.8rem; margin-top:6px">Formato esperado: Apellido, Nombre, Mail</p>
            </div>
        </div>

        <!-- Paso 2: Preview -->
        <div class="step" id="step2" style="display:none">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">Verificar datos</div>
            </div>
            <div id="stats"></div>
            <div id="tabla-container"></div>
            <div class="scroll-hint" id="scroll-hint" style="display:none">↕ Desplazá para ver todos</div>
            <div class="btn-group">
                <button class="btn btn-primary" id="btn-subir" onclick="subirTodo()">
                    Subir a Firebase
                </button>
                <button class="btn btn-secondary" onclick="resetear()">Cancelar</button>
            </div>
        </div>

        <!-- Paso 3: Resultado -->
        <div class="step" id="step3" style="display:none">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">Resultado</div>
            </div>
            <div id="progress-section" style="display:none">
                <p id="progress-text">Subiendo...</p>
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            </div>
            <div id="resultado"></div>
        </div>

    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDJDMsiLBABUdPMNaRyfJ-s2MTwse-kX1w",
        authDomain: "marina-pilates-730fb.firebaseapp.com",
        projectId: "marina-pilates-730fb",
        storageBucket: "marina-pilates-730fb.firebasestorage.app",
        messagingSenderId: "392495630154",
        appId: "1:392495630154:web:735dca0f037ded59ad63b3"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let alumnosParsed = [];
    let alumnosExistentes = new Set();
    let autorizadosExistentes = new Set();

    // LOGIN
    async function login() {
        const email = document.getElementById('login-email').value;
        const pw = document.getElementById('login-password').value;
        const errDiv = document.getElementById('login-error');
        errDiv.innerHTML = '';

        try {
            await auth.signInWithEmailAndPassword(email, pw);

            if (email !== 'marinapilatesestudio@gmail.com') {
                await auth.signOut();
                errDiv.innerHTML = '<div class="alert alert-danger">Solo el admin puede usar esta herramienta.</div>';
                return;
            }

            document.getElementById('login-section').style.display = 'none';
            document.getElementById('carga-section').style.display = 'block';

            // Precargar emails existentes
            const alumnosSnap = await db.collection('alumnos').get();
            alumnosSnap.forEach(doc => {
                const email = doc.data().email;
                if (email) alumnosExistentes.add(email.toLowerCase().trim());
            });

            const autSnap = await db.collection('alumnos_autorizados').get();
            autSnap.forEach(doc => {
                const email = doc.data().email;
                if (email) autorizadosExistentes.add(email.toLowerCase().trim());
            });

        } catch (e) {
            errDiv.innerHTML = '<div class="alert alert-danger">Error: ' + e.message + '</div>';
        }
    }

    // DRAG & DROP
    const dropZone = document.getElementById('file-drop');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    // PARSEAR ARCHIVO
    function handleFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(e.target.result, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

            // Detectar header
            const header = rows[0].map(h => h ? h.toString().toLowerCase().trim() : '');
            const colApellido = header.findIndex(h => h.includes('apellido'));
            const colNombre = header.findIndex(h => h.includes('nombre'));
            const colMail = header.findIndex(h => h.includes('mail') || h.includes('email') || h.includes('correo'));

            if (colMail === -1) {
                alert('No se encontró la columna de email. Asegurate de que el encabezado diga "Mail", "Email" o "Correo".');
                return;
            }

            alumnosParsed = [];
            const emailsSeen = new Set();

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[colMail]) continue;

                const email = row[colMail].toString().toLowerCase().trim();
                const nombre = colNombre >= 0 && row[colNombre] ? row[colNombre].toString().trim() : '';
                const apellido = colApellido >= 0 && row[colApellido] ? row[colApellido].toString().trim() : '';

                let status = 'new';
                if (!email || !email.includes('@')) {
                    status = 'error';
                } else if (emailsSeen.has(email)) {
                    status = 'duplicate';
                } else if (alumnosExistentes.has(email)) {
                    status = 'exists';
                }

                emailsSeen.add(email);

                alumnosParsed.push({ nombre, apellido, email, status });
            }

            mostrarPreview();
        };
        reader.readAsArrayBuffer(file);
    }

    // PREVIEW
    function mostrarPreview() {
        const newCount = alumnosParsed.filter(a => a.status === 'new').length;
        const existsCount = alumnosParsed.filter(a => a.status === 'exists').length;
        const errorCount = alumnosParsed.filter(a => a.status === 'error' || a.status === 'duplicate').length;

        document.getElementById('stats').innerHTML = `
            <div class="stats">
                <div class="stat stat-total">Total: ${alumnosParsed.length}</div>
                <div class="stat stat-new">Nuevos: ${newCount}</div>
                <div class="stat stat-exists">Ya existentes: ${existsCount}</div>
                ${errorCount > 0 ? `<div class="stat stat-error">Con errores: ${errorCount}</div>` : ''}
            </div>
            ${existsCount > 0 ? '<div class="alert alert-warning" style="margin-top:12px">Los alumnos marcados como "Ya existe" se saltearán. Solo se suben los nuevos.</div>' : ''}
        `;

        let html = '<table><thead><tr><th>#</th><th>Apellido</th><th>Nombre</th><th>Email</th><th>Estado</th></tr></thead><tbody>';
        alumnosParsed.forEach((a, i) => {
            const rowClass = a.status === 'exists' ? 'duplicate' : a.status === 'error' || a.status === 'duplicate' ? 'error' : '';
            const badge = a.status === 'new' ? '<span class="badge badge-new">Nuevo</span>' :
                          a.status === 'exists' ? '<span class="badge badge-exists">Ya existe</span>' :
                          '<span class="badge badge-error">Error</span>';
            html += `<tr class="${rowClass}"><td>${i + 1}</td><td>${a.apellido}</td><td>${a.nombre}</td><td>${a.email}</td><td>${badge}</td></tr>`;
        });
        html += '</tbody></table>';

        document.getElementById('tabla-container').innerHTML = html;
        if (alumnosParsed.length > 10) {
            document.getElementById('scroll-hint').style.display = 'block';
        }

        document.getElementById('step1').classList.remove('active');
        document.getElementById('step1').classList.add('done');
        document.getElementById('step2').style.display = 'block';
        document.getElementById('step2').classList.add('active');

        document.getElementById('btn-subir').disabled = newCount === 0;
        if (newCount === 0) {
            document.getElementById('btn-subir').textContent = 'No hay alumnos nuevos';
        }
    }

    // SUBIR
    async function subirTodo() {
        const nuevos = alumnosParsed.filter(a => a.status === 'new');
        if (nuevos.length === 0) return;

        document.getElementById('btn-subir').disabled = true;
        document.getElementById('step3').style.display = 'block';
        document.getElementById('step3').classList.add('active');
        document.getElementById('progress-section').style.display = 'block';

        let subidos = 0;
        let errores = 0;
        const total = nuevos.length;

        for (const alumno of nuevos) {
            try {
                // Subir a alumnos
                await db.collection('alumnos').add({
                    nombre: alumno.nombre,
                    apellido: alumno.apellido,
                    email: alumno.email,
                    activo: false,
                    abono: '2x_semana',
                    clasesTotales: 8,
                    clasesUsadas: 0,
                    clasesPendientes: 0,
                    horariosAsignados: []
                });

                // Subir a alumnos_autorizados (si no existe ya)
                if (!autorizadosExistentes.has(alumno.email)) {
                    await db.collection('alumnos_autorizados').add({ email: alumno.email });
                    autorizadosExistentes.add(alumno.email);
                }

                alumnosExistentes.add(alumno.email);
                subidos++;
            } catch (e) {
                console.error('Error subiendo', alumno.email, e);
                errores++;
            }

            // Update progress
            const pct = Math.round(((subidos + errores) / total) * 100);
            document.getElementById('progress-fill').style.width = pct + '%';
            document.getElementById('progress-text').textContent = `Subiendo... ${subidos + errores} / ${total}`;
        }

        document.getElementById('progress-section').style.display = 'none';
        document.getElementById('step2').classList.remove('active');
        document.getElementById('step2').classList.add('done');

        let html = `<div class="alert alert-success">
            <strong>¡Listo!</strong> Se subieron <strong>${subidos}</strong> alumnos a Firebase.
        </div>`;

        if (errores > 0) {
            html += `<div class="alert alert-danger">${errores} alumno(s) no se pudieron subir. Revisá la consola (F12).</div>`;
        }

        html += `
            <div class="stats">
                <div class="stat stat-new">Subidos a <strong>alumnos</strong>: ${subidos}</div>
                <div class="stat stat-new">Subidos a <strong>alumnos_autorizados</strong>: ${subidos}</div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="resetear()">Cargar otro archivo</button>
                <button class="btn btn-secondary" onclick="window.location.href='/'">Ir a la app</button>
            </div>
        `;

        document.getElementById('resultado').innerHTML = html;
    }

    // RESET
    function resetear() {
        alumnosParsed = [];
        document.getElementById('file-input').value = '';
        document.getElementById('step1').classList.add('active');
        document.getElementById('step1').classList.remove('done');
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step2').classList.remove('active', 'done');
        document.getElementById('step3').style.display = 'none';
        document.getElementById('step3').classList.remove('active', 'done');
        document.getElementById('resultado').innerHTML = '';
        document.getElementById('scroll-hint').style.display = 'none';
    }
</script>

</body>
</html>
